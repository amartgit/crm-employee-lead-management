<?php

namespace App\Http\Controllers;

use App\Models\Attendance;
use App\Models\Employee;
use App\Models\Breakemp;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Carbon\Carbon;

class AttendanceController extends Controller
{
    public function index()
    {
        $employee = Employee::where('employee_id', Auth::user()->employee_id)->first();
        $attendances = Attendance::where('employee_id', Auth::user()->employee_id)
            ->orderBy('date', 'desc')
            ->paginate(10);

        return view('employee.attendance.index', compact('employee', 'attendances'));
    }

    public function checkIn(Request $request)
    {
        $today = Carbon::today();
        $now = Carbon::now();

        $attendance = Attendance::firstOrCreate(
            ['employee_id' => Auth::user()->employee_id, 'date' => $today],
            ['check_in' => $now]
        );

        if ($attendance->check_in && $attendance->check_in->ne($now)) {
            return redirect()->back()->with('error', 'You have already checked in today.');
        }

        $attendance->check_in = $now;
        $attendance->save();

        return redirect()->back()->with('success', 'Check-in successful at ' . $now->format('h:i A') . '.');
    }

    public function checkOut(Request $request)
    {
        $today = Carbon::today();
        $now = Carbon::now();

        $attendance = Attendance::where('employee_id', Auth::user()->employee_id)
            ->where('date', $today)
            ->first();

        if (!$attendance || !$attendance->check_in) {
            return redirect()->back()->with('error', 'You need to check in first.');
        }

        if ($attendance->check_out) {
            return redirect()->back()->with('error', 'You have already checked out today.');
        }

        $attendance->check_out = $now;
        $attendance->save();

        // Calculate working time after check-out
        $attendance->calculateWorkingTime();

        return redirect()->back()->with('success', 'Check-out successful at ' . $now->format('h:i A') . '.');
    }


    public function addNote(Request $request, $id)
    {
        $request->validate([
            'notes' => 'required|string|max:255',
        ]);

        $attendance = Attendance::findOrFail($id);

        if ($attendance->employee_id !== Auth::user()->employee_id) {
            return redirect()->back()->with('error', 'You are not authorized to add notes to this attendance record.');
        }

        $attendance->notes = $request->notes;
        $attendance->save();

        return redirect()->back()->with('success', 'Note added successfully.');
    }


    public function logBreakemp(Request $request, $attendanceId)
    {
        $request->validate([
            'type' => 'required|string|max:255',
            'start_time' => 'required|date_format:H:i',
            'end_time' => 'required|date_format:H:i|after:start_time',
        ]);

        $attendance = Attendance::findOrFail($attendanceId);

        // Log the break
        $attendance->breakemps()->create([
            'type' => $request->type,
            'start_time' => $request->start_time,
            'end_time' => $request->end_time,
        ]);

        return redirect()->back()->with('success', 'Break logged successfully.');
    }


    public function adminDashboard()
    {
        $employees = Employee::all();
        $currentMonth = Carbon::now()->format('Y-m');
        return view('admin.attendance.dashboard', compact('employees', 'currentMonth'));
    }

    public function adminMonthlyView(Request $request)
    {
        $employeeId = $request->input('employee_id');
        $month = $request->input('month', Carbon::now()->format('Y-m'));

        $employee = Employee::findOrFail($employeeId);
        $attendances = Attendance::where('employee_id', $employeeId)
            ->whereYear('date', substr($month, 0, 4))
            ->whereMonth('date', substr($month, 5, 2))
            ->orderBy('date', 'asc')
            ->get();

        $calendar = $this->generateCalendar($month, $attendances);

        return view('admin.attendance.monthly', compact('employee', 'month', 'calendar'));
    }

    public function adminDailyView(Request $request)
    {
        $employeeId = $request->input('employee_id');
        $date = $request->input('date', Carbon::now()->toDateString());

        $employee = Employee::findOrFail($employeeId);
        $attendance = Attendance::where('employee_id', $employeeId)
            ->where('date', $date)
            ->first();

        return view('admin.attendance.daily', compact('employee', 'date', 'attendance'));
    }

    public function adminVerify(Request $request, $id)
    {
        $attendance = Attendance::findOrFail($id);
        $attendance->verified = true;
        $attendance->save();

        return redirect()->route('admin.attendance.daily', [
            'employee_id' => $attendance->employee_id,
            'date' => $attendance->date->toDateString()
        ])->with('success', 'Attendance record verified successfully.');
    }

    public function adminUnverify(Request $request, $id)
    {
        $attendance = Attendance::findOrFail($id);
        $attendance->verified = false;
        $attendance->save();

        return redirect()->route('admin.attendance.daily', [
            'employee_id' => $attendance->employee_id,
            'date' => $attendance->date->toDateString()
        ])->with('success', 'Attendance record unverified successfully.');
    }

    private function generateCalendar($month, $attendances)
    {
        $calendar = [];
        $date = Carbon::createFromFormat('Y-m', $month)->startOfMonth();
        $endDate = $date->copy()->endOfMonth();

        while ($date <= $endDate) {
            $attendance = $attendances->firstWhere('date', $date->toDateString());
            $calendar[] = [
                'date' => $date->toDateString(),
                'day' => $date->day,
                'attendance' => $attendance,
                'status' => $attendance ? $attendance->status : 'Absent'
            ];
            $date->addDay();
        }

        return $calendar;
    }



    public function adminShowAttendance($id)
    {
        $attendance = Attendance::with('employee', 'breakemps')->findOrFail($id);
        $totalWorkingHours = $attendance->total_working_hours;
        $status = $attendance->status;

        return view('admin.attendance.show', compact('attendance', 'totalWorkingHours', 'status'));
    }
}

